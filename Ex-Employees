⸻

USE CASE GOAL

Detect any successful login activity by users listed in the ex_employees lookup, excluding entries older than one year.

⸻

PREREQUISITES
	•	ex_employees lookup exists
	•	Fields in lookup:
	•	user
	•	fullname
	•	entryDate
	•	department
	•	comment
	•	Authentication data model is populated and accelerated
	•	You have read-only access, admin will create the alert later if needed

⸻

STEP 1: Validate lookup data quality

Run:

| inputlookup ex_employees
| stats count by user

Check:
	•	user values match Authentication.user format
	•	No empty user values
	•	entryDate format is consistent

⸻

STEP 2: Validate Authentication DM login data

Run:

| tstats count
from datamodel=Authentication.Authentication
where Authentication.action=success
by Authentication.user
| head 20

Check:
	•	Authentication.user has real usernames
	•	Counts are non-zero

⸻

STEP 3: Build the base login search

Use this as the base detection.

| tstats earliest(_time) as first_time latest(_time) as last_time count as event_count
from datamodel=Authentication.Authentication
where Authentication.action=success
by Authentication.user Authentication.app Authentication.dest Authentication.src Authentication.signature
| rename Authentication.* as *

⸻

STEP 4: Normalize username for lookup match

Add:

| eval user_norm=lower(replace(user,”^.*\\”,””))

Purpose:
	•	Removes DOMAIN\
	•	Normalizes case

⸻

STEP 5: Match against ex_employees lookup

Add:

| lookup ex_employees user as user_norm OUTPUT user as ex_user fullname department entryDate comment
| where isnotnull(ex_user)

Only ex-employees remain.

⸻

STEP 6: Exclude entries older than one year

Add:

| eval entry_epoch=strptime(entryDate,”%Y-%m-%d”)
| where isnotnull(entry_epoch)
| where entry_epoch >= relative_time(now(), “-365d@d”)

Adjust date format if needed.

⸻

STEP 7: Handle src field variability

src can be hostname, IP, or unknown.

Add:

| eval src_norm=lower(trim(src))
| eval src_ip=if(match(src_norm,”^\d{1,3}(.\d{1,3}){3}$”), src_norm, null())

⸻

STEP 8: Create alert-friendly output

Add:

| stats
earliest(first_time) as first_seen
latest(last_time) as last_seen
sum(event_count) as total_events
values(app) as apps
values(dest) as dests
values(src) as src_values
values(src_ip) as src_ips
values(signature) as signatures
values(fullname) as fullname
values(department) as department
values(entryDate) as entryDate
values(comment) as comment
by user
| eval first_seen=strftime(first_seen,”%Y-%m-%d %H:%M:%S”), last_seen=strftime(last_seen,”%Y-%m-%d %H:%M:%S”)
| sort - total_events

⸻

STEP 9: FULL FINAL SEARCH

Copy and run this end-to-end.

| tstats earliest(_time) as first_time latest(_time) as last_time count as event_count
from datamodel=Authentication.Authentication
where Authentication.action=success
by Authentication.user Authentication.app Authentication.dest Authentication.src Authentication.signature
| rename Authentication.* as *
| eval user_norm=lower(replace(user,”^.*\\”,””))
| lookup ex_employees user as user_norm OUTPUT user as ex_user fullname department entryDate comment
| where isnotnull(ex_user)
| eval entry_epoch=strptime(entryDate,”%Y-%m-%d”)
| where isnotnull(entry_epoch)
| where entry_epoch >= relative_time(now(), “-365d@d”)
| eval src_norm=lower(trim(src))
| eval src_ip=if(match(src_norm,”^\d{1,3}(.\d{1,3}){3}$”), src_norm, null())
| stats
earliest(first_time) as first_seen
latest(last_time) as last_seen
sum(event_count) as total_events
values(app) as apps
values(dest) as dests
values(src) as src_values
values(src_ip) as src_ips
values(signature) as signatures
values(fullname) as fullname
values(department) as department
values(entryDate) as entryDate
values(comment) as comment
by user
| eval first_seen=strftime(first_seen,”%Y-%m-%d %H:%M:%S”), last_seen=strftime(last_seen,”%Y-%m-%d %H:%M:%S”)
| sort - total_events

⸻

STEP 10: Turn this into a use case

If admin creates it as alert:
	•	Scheduled search
	•	Every 15 minutes
	•	Last 15 minutes
	•	Trigger when results > 0
	•	Severity High

If admin creates it in ES:
	•	Correlation search
	•	Access or Identity domain
	•	Notable severity High

⸻

NEXT IMPROVEMENTS (LATER)
	•	Add VPN-only filter
	•	Add cloud-only filter
	•	Add risk scoring
	•	Add off-hours logic
	•	Add allowlist
